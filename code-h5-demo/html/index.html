<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="format-detection" content="telephone=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="wap-font-scale" content="no">
    <title>Demo</title>
    <script src="" ></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
</head>

<body>
<div id="navbar">
    <a href="javascript:void(0)" onclick="javascript:history.go(-1);return false;" > 返回</a>  
</div>
<br/>
<div id="login-pannel">
    <a href="#">点击登录</a>
</div>
<div id="profile-pannel" style="display: none;">
    <h1>
        会员信息
    </h1>

    <h3>用户昵称：<span id="nickname">-</span></h3>

    <h3>当前积分：<span id="current-score">-</span></h3>

    <h3>当前余额：<span id="current-balance">-</span></h3>
    <input type="text" id="nickname-input" placeholder="填写要修改的昵称"/>
    <button id="changeScore">修改</button>
    <p>
        <a href="https://www.maxwon.cn/member/setting">设置</a>
    </p>
</div>

</body>
<script type="text/javascript">

    function setLoginReturnUri(return_uri) {
        $("#login-pannel a").attr("href","http://h5custom.maxwon.cn/login?return_uri="+return_uri)
    }

    //获取地址栏参数
    function getQueryString(name) {
        console.log("getQueryString window.location:",window.location);
        name = name.toLowerCase();
        var search = window.location.search.toLowerCase();
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", 'i');
        var result = search.substr(1).match(reg);
        console.log("====> getQueryString name:",name, "result:",result);

        if (result != null) {
            return unescape(result[2]);
        }
        return null;
    }

    function bootstrap() {
        var baseUrl = "https://wonapi.maxleap.cn/1.0/"
        var nicknameTag = document.getElementById("nickname");
        var currentScoreTag = document.getElementById("current-score");
        var currentBalanceTag = document.getElementById("current-balance");
        var changeScoreTag = document.getElementById("changeScore");
        var nicknameInput = document.getElementById("nickname-input");

        var currentUrl = window.location.href;
        setLoginReturnUri(currentUrl);

        var appId = getQueryString("maxleap_appid");
        var sessionToken = getQueryString("maxleap_sessiontoken");
        var memId = getQueryString("maxleap_userid");

        if (memId && sessionToken) {
            // 已经登录
            $("#login-pannel").hide();
            $("#profile-pannel").show();
            $.ajaxSetup({
                contentType : 'application/json',
                headers:{
                    "Content-Type": "application/json",
                    "X-ML-AppId":appId,
                    "X-ML-Session-Token":sessionToken,
                }
            });
            bindChangeScoreEvent();
            getMemberInfoAndRender();
        }else{
            // 未登录
            $("#login-pannel").show();
            $("#profile-pannel").hide();
        }

        //获取会员信息并渲染页面
        function getMemberInfoAndRender() {
            var url = baseUrl+"mems/" + memId;
            $.ajax({
                url, 
                success:function (res) {
                    if (res) {
                        nicknameTag.innerText = res.nickName;
                        currentScoreTag.innerText = res.integral;
                        currentBalanceTag.innerText = (res.balance / 100).toFixed(2);
                    }
                }, 
                error:function (error) {
                    console.log("getMemberInfoAndRender error:",error);
                    alert("获取会员信息失败");
                }
            });
        }

        //绑定修改点击事件
        function bindChangeScoreEvent() {
            changeScoreTag.addEventListener("click", function (e) {
                var value = nicknameInput.value.trim();

                if (value !== '') {
                    updateMemberInfo({
                        nickName: value
                    });
                    nicknameInput.value = '';
                }
            });
        }

        //更新会员信息
        function updateMemberInfo(info) {
            $.ajax({
                url: baseUrl+"mems/" + memId, 
                data: JSON.stringify(info),
                type:"PUT",
                success:function (res) {
                    alert("修改成功");
                    nicknameTag.innerText = info.nickName;
                }, 
                error:function (error) {
                   alert("修改失败");
                }
            });
        }
    }

    $(document).ready(function(){
      bootstrap();
    });
</script>

</html>
